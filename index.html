<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Spese - Dashboard iOS Style</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- Font system iOS-like -->
<style>
  @font-face {
    font-family: 'SF Pro Text';
    src: local('SF Pro Text'), local('San Francisco'), local('Helvetica Neue'), local('Helvetica'), local('Arial'), sans-serif;
  }
  body {
    font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #f5f5f7;
    color: #1c1c1e;
    padding-top: 4.5rem;
  }
  /* Navbar */
  nav.navbar {
    background: #fff;
    border-bottom: 1px solid #ddd;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.05);
  }
  nav.navbar .navbar-brand {
    font-weight: 600;
    font-size: 1.4rem;
    color: #007aff;
  }
  nav.navbar .nav-tabs {
    border-bottom: none;
  }
  nav.navbar .nav-link {
    color: #007aff;
    font-weight: 600;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 1rem;
    transition: background-color 0.3s;
  }
  nav.navbar .nav-link.active,
  nav.navbar .nav-link:hover {
    background: #007aff;
    color: white !important;
  }
  /* Container */
  .container {
    max-width: 480px;
  }
  /* Dashboard Cards */
  .dashboard {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .card-dashboard {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 10px 15px rgb(0 122 255 / 0.15);
    padding: 1.5rem 1rem;
    text-align: center;
    color: #007aff;
    font-weight: 700;
    user-select: none;
  }
  .card-dashboard .icon {
    font-size: 2.5rem;
    margin-bottom: 0.3rem;
  }
  .card-dashboard .label {
    font-weight: 500;
    font-size: 0.9rem;
    color: #3a3a3c;
  }
  .card-dashboard .value {
    font-size: 1.7rem;
    margin-top: 0.2rem;
  }
  /* Buttons */
  button.btn {
    border-radius: 1.5rem;
    font-weight: 600;
    padding: 0.5rem 1.4rem;
    box-shadow: 0 4px 8px rgb(0 122 255 / 0.2);
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  button.btn-primary {
    background-color: #007aff;
    border: none;
  }
  button.btn-primary:hover {
    background-color: #005ecb;
    box-shadow: 0 6px 14px rgb(0 122 255 / 0.3);
  }
  button.btn-success {
    background-color: #34c759;
    border: none;
  }
  button.btn-success:hover {
    background-color: #28a745;
    box-shadow: 0 6px 14px rgb(52 199 89 / 0.3);
  }
  /* Form controls */
  input.form-control, select.form-select {
    border-radius: 1rem;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    padding: 0.5rem 1rem;
    font-weight: 600;
    font-size: 1rem;
  }
  input.form-control:focus, select.form-select:focus {
    border-color: #007aff;
    box-shadow: 0 0 8px rgb(0 122 255 / 0.5);
  }
  /* Lista Spese cards */
  .card-spesa {
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.07);
    margin-bottom: 1rem;
    transition: box-shadow 0.3s;
  }
  .card-spesa:hover {
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
  }
  .card-spesa .card-body {
    padding: 1rem 1.2rem;
  }
  .card-spesa .card-title {
    font-weight: 700;
    font-size: 1.1rem;
  }
  .card-spesa .card-text {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  .tipologia-Spesa\ effettiva {
    background-color: #007aff;
    color: white;
  }
  .tipologia-Spesa\ programmata {
    background-color: #ff9500;
    color: white;
  }
  .tipologia-Aggiunta\ Budget {
    background-color: #34c759;
    color: white;
  }
  /* Select tipologia nella card */
  select.form-select-sm {
    border-radius: 1rem;
    width: auto;
    font-weight: 600;
    padding: 0.25rem 0.6rem;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
    cursor: pointer;
    transition: box-shadow 0.3s;
  }
  select.form-select-sm:focus {
    box-shadow: 0 0 6px rgb(0 122 255 / 0.5);
  }
  /* Delete button */
  button.btn-danger {
    border-radius: 1rem;
    font-weight: 600;
    padding: 0.3rem 0.8rem;
    font-size: 0.85rem;
    box-shadow: none;
    transition: background-color 0.3s;
  }
  button.btn-danger:hover {
    background-color: #cc0000;
    box-shadow: 0 0 8px rgb(204 0 0 / 0.5);
  }
  /* Pills for sub-tabs */
  #listSubTabs .nav-link {
    border-radius: 1.5rem;
    font-weight: 600;
    color: #007aff;
    padding: 0.4rem 1rem;
    margin-right: 0.4rem;
  }
  #listSubTabs .nav-link.active {
    background-color: #007aff;
    color: white !important;
    box-shadow: 0 4px 10px rgb(0 122 255 / 0.3);
  }
  /* Responsive */
  @media (max-width: 400px) {
    .dashboard {
      grid-template-columns: 1fr;
    }
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }
</style>
</head>
<body>

<nav class="navbar fixed-top">
  <div class="container d-flex flex-column align-items-start">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" style="display:none;">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab">üè† Home</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">‚ûï Aggiungi Spesa</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">üìã Lista Spese</button>
      </li>
       <li class="nav-item" role="presentation">
        <button class="nav-link" id="Cal-tab" data-bs-toggle="tab" data-bs-target="#month" type="button" role="tab">üìÖ Calendario</button>
      </li>
    </ul>
  </div>
</nav>

<div id="welcomeScreen" class="d-flex flex-column align-items-center" style="height:100vh;">
  <form id="choosePlanForm" class="w-100 p-3" style="max-width: 400px;">
    <div class="mb-3">
      <label for="pianoSelect" class="form-label">Seleziona un piano</label>
      <select id="pianoSelect" class="form-select" required></select>
    </div>
    <button type="submit" class="btn btn-primary w-100">Apri Piano</button>
  </form>

  <hr class="my-4" style="width: 100px;"/>

  <form id="createPlanForm" class="w-100 p-3" style="max-width: 400px;">
    <div class="mb-3">
      <label for="titoloInputPiano" class="form-label">Oppure crea nuovo piano</label>
      <input type="text" class="form-control" id="titoloInputPiano" placeholder="Titolo del Piano" required />
    </div>
    <button type="submit" class="btn btn-success w-100">Crea Piano</button>
  </form>

  
      <div class="d-flex gap-2 mb-4">
        <button id="saveBtn" class="btn btn-primary flex-fill">üíæ Salva dati JSON</button>
        <button id="loadBtn" class="btn btn-success flex-fill">üìÇ Carica dati JSON</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;">
      </div>
</div>


<div class="container">

  <div class="tab-content" id="mainTabsContent">

    <!-- HOME / DASHBOARD -->
    <div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
        <hr class="my-4" style="width: 100px;"/>
      <div class="dashboard">
        <div class="card-dashboard" id="cardSpeseEffettive">
          <div class="icon">üí∏</div>
          <div class="label">Spese Effettive</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
        <div class="card-dashboard" id="cardSpeseProgrammate">
          <div class="icon">üóìÔ∏è</div>
          <div class="label">Spese Programmate</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
        <div class="card-dashboard" id="cardBudget">
          <div class="icon">üí∞</div>
          <div class="label">Budget</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
        <div class="card-dashboard" id="cardRimanente">
          <div class="icon">üìä</div>
          <div class="label">Rimanente</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
      </div>
    </div>

    <!-- AGGIUNGI SPESA -->
    <div class="tab-pane fade" id="add" role="tabpanel" aria-labelledby="add-tab">
         <hr class="my-4" style="width: 100px;"/>
      <form id="addSpesaForm" autocomplete="off">
        <div class="mb-3">
          <label for="titoloInput" class="form-label">Titolo spesa</label>
          <input type="text" class="form-control" id="titoloInput" placeholder="Descrizione della spesa" required />
        </div>
        <div class="mb-3 d-flex gap-2"">
            <label for="dateInput" class="form-label">Seleziona la data</label>
            <input type="date" class="form-control" id="dateInput" name="dateInput" />
        </div>
        <div class="mb-3 d-flex gap-2">
          <div class="flex-grow-1">
            <label for="importoInput" class="form-label">Importo</label>
            <input type="number" step="0.01" min="0" class="form-control" id="importoInput" placeholder="0.00" required />
          </div>
          <div style="width: 100px;">
            <label for="valutaInput" class="form-label">Valuta</label>
            <input type="text" class="form-control" id="valutaInput" placeholder="‚Ç¨" maxlength="3" />
          </div>
        </div>
        <div class="mb-4">
          <label for="tipologiaInput" class="form-label">Tipologia</label>
          <select id="tipologiaInput" class="form-select" required>
            <option value="Spesa effettiva">Spesa effettiva</option>
            <option value="Spesa programmata">Spesa programmata</option>
            <option value="Aggiunta Budget">Aggiunta Budget</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary w-100">Aggiungi Spesa</button>
      </form>
    </div>

    <!-- LISTA SPESE -->
    <div class="tab-pane fade" id="list" role="tabpanel" aria-labelledby="list-tab">
        <hr class="my-4" style="width: 100px;"/>

      <ul class="nav nav-pills mb-3" id="listSubTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="effettive-tab" data-bs-toggle="pill" data-bs-target="#effettive" type="button" role="tab">Spese Effettive</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="programmate-tab" data-bs-toggle="pill" data-bs-target="#programmate" type="button" role="tab">Spese Programmate</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="budget-tab" data-bs-toggle="pill" data-bs-target="#budget" type="button" role="tab">Aggiunte Budget</button>
        </li>
      </ul>

      <div class="tab-content" id="listSubTabsContent">
        <div class="tab-pane fade show active" id="effettive" role="tabpanel" aria-labelledby="effettive-tab">
          <div id="effettiveContainer"></div>
        </div>
        <div class="tab-pane fade" id="programmate" role="tabpanel" aria-labelledby="programmate-tab">
          <div id="programmateContainer"></div>
        </div>
        <div class="tab-pane fade" id="budget" role="tabpanel" aria-labelledby="budget-tab">
          <div id="budgetContainer"></div>
        </div>
      </div>
    </div>

    <!-- MONTH -->
<div class="tab-pane fade" id="month" role="tabpanel" aria-labelledby="month-tab">
            <hr class="my-4" style="width: 100px;"/>
  <div class="row g-4">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card month-card fade-in bg-primary text-white" style="animation-delay: 0.1s;">
        <div class="card-body text-center">
          <div class="month-header">
            <i class="bi bi-calendar3"></i> Gennaio
          </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
            </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card month-card fade-in bg-secondary text-white" style="animation-delay: 0.2s;">
        <div class="card-body text-center">
          <div class="month-header">
            <i class="bi bi-calendar3"></i> Febbraio
          </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card month-card fade-in bg-success text-white" style="animation-delay: 0.3s;">
        <div class="card-body text-center">
          <div class="month-header">
            <i class="bi bi-calendar3"></i> Marzo
          </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card month-card fade-in bg-danger text-white" style="animation-delay: 0.4s;">
        <div class="card-body text-center">
          <div class="month-header">
            <i class="bi bi-calendar3"></i> Aprile
          </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        </div>
      </div>
    </div>
     <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-info text-white" style="animation-delay: 0.6s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Maggio
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-info text-white" style="animation-delay: 0.6s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Giugno
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-primary text-white" style="animation-delay: 0.7s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Luglio
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-secondary text-white" style="animation-delay: 0.8s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Agosto
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-success text-white" style="animation-delay: 0.9s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Settembre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-danger text-white" style="animation-delay: 1s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Ottobre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-warning text-dark" style="animation-delay: 1.1s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Novembre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card month-card fade-in bg-info text-white" style="animation-delay: 1.2s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Dicembre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
      </div>
    </div>
  </div>
</div>
  </div>
</div>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let spese = [];
  let piani =[];
  let currentPiano ="";
document.getElementById('createPlanForm').addEventListener('submit', (e) => {
  e.preventDefault(); // Blocca il comportamento predefinito del form

  const titolo = document.getElementById('titoloInputPiano').value.trim();
  piani.push(new PianoAccumulo(titolo));
  savePiano();
  currentPiano = titolo;
  const welcome = document.getElementById('welcomeScreen');
  welcome.classList.remove('d-flex');
  welcome.classList.add('d-none');

  loadData();
  updateRiepilogo();
  renderSpeseList();

  document.getElementById('mainTabs').style.display = 'flex';

  const homePane = document.getElementById('home');
  homePane.classList.add('show', 'active');
});
function popolaSelectPiani() {
  const select = document.getElementById('pianoSelect');
  select.innerHTML = "";

  if (piani.length === 0) {
    const option = document.createElement('option');
    option.textContent = "Nessun piano disponibile";
    option.disabled = true;
    option.selected = true;
    select.appendChild(option);
  } else {
    piani.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.id;
      select.appendChild(option);
    });
  }
}
document.getElementById('choosePlanForm').addEventListener('submit', e => {
  e.preventDefault();
  const selectedId = document.getElementById('pianoSelect').value;
  pianoCorrente = piani.find(p => p.id === selectedId);

  if (!pianoCorrente) return alert("Errore nel caricamento piano.");

    currentPiano = pianoCorrente.id;
  const welcome = document.getElementById('welcomeScreen');
  welcome.classList.remove('d-flex');
  welcome.classList.add('d-none');

  loadData();
  updateRiepilogo();
  renderSpeseList();

  document.getElementById('mainTabs').style.display = 'flex';

  const homePane = document.getElementById('home');
  homePane.classList.add('show', 'active');
});




  class Spesa {
    constructor(titolo, importo, valuta, tipologia,piano,data) {
      this.titolo = titolo;
      this.importo = importo;
      this.valuta = valuta;
      this.tipologia = tipologia;
      this.piano = piano;
      this.data=data;
    }
  }
  class PianoAccumulo {
    constructor(id) {
      this.id = id;
    }
  }
    class JsonExport {
    constructor(spese,piani) {
      this.spese = spese;
      this.piani = piani;
    }
  }



  const saveData = () => {
    const dati = localStorage.getItem('spese');
    var speseTemp = [];
    if (dati) {
      try {
        const arr = JSON.parse(dati);
         speseTemp = arr
        .filter(s => s.piano !== currentPiano)
        .map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
         speseTemp = [];
      }
    }
    const merged = speseTemp.concat(spese);
    localStorage.setItem('spese', JSON.stringify(merged));
  };
  const savePiano = () => {
    localStorage.setItem('piano', JSON.stringify(piani));
  };

  const loadData = () => {
    const dati = localStorage.getItem('spese');
    if (dati) {
      try {
        const arr = JSON.parse(dati);
        spese = arr
        .filter(s => s.piano === currentPiano)
        .map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
        spese = [];
      }
    }
  };

  const loadPiano = () => {
    const dati = localStorage.getItem('piano');
    if (dati) {
      try {
        const arr = JSON.parse(dati);
        piani = arr.map(s => new PianoAccumulo(s.id));
      } catch {
        piani = [];
      }
    }
  };

  // Elementi DOM containers
  const effettiveCont = document.getElementById('effettiveContainer');
  const programmateCont = document.getElementById('programmateContainer');
  const budgetCont = document.getElementById('budgetContainer');

  // Dashboard cards
  const cardSpeseEffettive = document.getElementById('cardSpeseEffettive').querySelector('.value');
  const cardSpeseProgrammate = document.getElementById('cardSpeseProgrammate').querySelector('.value');
  const cardBudget = document.getElementById('cardBudget').querySelector('.value');
  const cardRimanente = document.getElementById('cardRimanente').querySelector('.value');

  function formatCurrency(value, valuta = "‚Ç¨") {
    return value.toFixed(2) + " " + valuta;
  }

  function updateRiepilogo() {
    let totEffettive = 0;
    let totProgrammate = 0;
    let totBudget = 0;
    let valuta = "‚Ç¨";

    spese.forEach(s => {
      valuta = s.valuta || valuta;
      if (s.tipologia === "Spesa effettiva") totEffettive += s.importo;
      else if (s.tipologia === "Spesa programmata") totProgrammate += s.importo;
      else if (s.tipologia === "Aggiunta Budget") totBudget += s.importo;
    });

    cardSpeseEffettive.textContent = formatCurrency(totEffettive, valuta);
    cardSpeseProgrammate.textContent = formatCurrency(totProgrammate, valuta);
    cardBudget.textContent = formatCurrency(totBudget, valuta);
    const rimanente = totBudget - totEffettive - totProgrammate ;
    cardRimanente.textContent = formatCurrency(rimanente, valuta);
    cardRimanente.style.color = rimanente < 0 ? '#cc0000' : '#007aff';
  }

  function renderSpeseList() {
    effettiveCont.innerHTML = "";
    programmateCont.innerHTML = "";
    budgetCont.innerHTML = "";

    spese.forEach((spesa, index) => {
      const card = document.createElement('div');
      card.className = 'card card-spesa';

      const cardBody = document.createElement('div');
      cardBody.className = 'card-body d-flex flex-column flex-sm-row justify-content-between align-items-center';

      // Titolo e importo
      const infoDiv = document.createElement('div');
      infoDiv.className = 'flex-grow-1';

      const titolo = document.createElement('h5');
      titolo.className = 'card-title mb-1';
      titolo.textContent = spesa.titolo+" - "+spesa.data;

infoDiv.appendChild(titolo);

// DIV contenente input importo + etichetta valuta
const importoWrapper = document.createElement('div');
importoWrapper.className = 'd-flex align-items-center';

const importoInput = document.createElement('input');
importoInput.type = 'number';
importoInput.className = 'form-control';
importoInput.style.cssText = `
  max-width: 80px;
  padding: 0.2rem 0.5rem;
  font-size: 0.85rem;
  height: auto;
  border-radius: 0.6rem;
  box-shadow: none;
  border: 1px solid #ccc;
`;
importoInput.value = spesa.importo;
importoInput.min = "0";
importoInput.step = "0.01";
importoInput.title = "Modifica importo";

importoInput.addEventListener('change', () => {
  const nuovoImporto = parseFloat(importoInput.value);
  if (!isNaN(nuovoImporto) && nuovoImporto >= 0) {
    spesa.importo = nuovoImporto;
    saveData();
    updateRiepilogo();
    renderSpeseList(); // rirenderizza la lista
  } else {
    alert("Importo non valido");
    importoInput.value = spesa.importo;
  }
});

const valutaSpan = document.createElement('span');
valutaSpan.className = 'ms-2';
valutaSpan.textContent = spesa.valuta || "‚Ç¨";

// Appendi input + valuta al wrapper
importoWrapper.appendChild(importoInput);
importoWrapper.appendChild(valutaSpan);

// Appendi wrapper al contenitore info
infoDiv.appendChild(importoWrapper);


      // Select tipologia
      const selectTipologia = document.createElement('select');
      selectTipologia.className = 'form-select form-select-sm me-2';
      ["Spesa effettiva", "Spesa programmata", "Aggiunta Budget"].forEach(tipo => {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo;
        if (spesa.tipologia === tipo) option.selected = true;
        selectTipologia.appendChild(option);
      });
      selectTipologia.title = "Modifica tipologia spesa";

      selectTipologia.addEventListener('change', () => {
        spesa.tipologia = selectTipologia.value;
        saveData();
        updateRiepilogo();
        renderSpeseList();
      });

     

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-danger btn-sm';
      deleteBtn.textContent = "Elimina";
      deleteBtn.title = "Elimina spesa";
      deleteBtn.addEventListener('click', () => {
        if (confirm(`Eliminare la spesa "${spesa.titolo}"?`)) {
          spese.splice(index, 1);
          saveData();
          updateRiepilogo();
          renderSpeseList();
        }
      });

      const rightControls = document.createElement('div');
      rightControls.className = 'd-flex align-items-center gap-2 mt-3 mt-sm-0';

      rightControls.appendChild(selectTipologia);
      rightControls.appendChild(deleteBtn);

      cardBody.appendChild(infoDiv);
      cardBody.appendChild(rightControls);

      card.appendChild(cardBody);

      // Append card nel contenitore giusto
      if (spesa.tipologia === "Spesa effettiva") effettiveCont.appendChild(card);
      else if (spesa.tipologia === "Spesa programmata") programmateCont.appendChild(card);
      else if (spesa.tipologia === "Aggiunta Budget") budgetCont.appendChild(card);
    });
  }

  // Gestione form aggiunta spesa
  document.getElementById('addSpesaForm').addEventListener('submit', e => {
    e.preventDefault();

    const titolo = document.getElementById('titoloInput').value.trim();
    const importo = parseFloat(document.getElementById('importoInput').value);
    const valutaInput = document.getElementById('valutaInput').value.trim();
    const valuta = valutaInput || "‚Ç¨";
    var data = document.getElementById('dateInput').value;
    const tipologia = document.getElementById('tipologiaInput').value;

    if (!titolo || isNaN(importo) || !tipologia) {
      alert("Compila tutti i campi correttamente!");
      return;
    }

    spese.push(new Spesa(titolo, importo, valuta, tipologia, currentPiano,data));
    console.log("Aggiunto spesa");
    saveData();
    updateRiepilogo();
    renderSpeseList();

    e.target.reset();

    // Torna alla lista spese dopo aggiunta
    const tabTrigger = bootstrap.Tab.getOrCreateInstance(document.querySelector('#list-tab'));
    tabTrigger.show();
  });

  // Salva dati in JSON
  document.getElementById('saveBtn').addEventListener('click', () => {
    const datiFULLspese = localStorage.getItem('spese');
    const datiFULLpiani = localStorage.getItem('piano');
     const dati = localStorage.getItem('spese');
    var speseTemp = [];
    if (datiFULLspese) {
      try {
        const arr = JSON.parse(datiFULLspese);
         speseTemp = arr.map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
         speseTemp = [];
      }
    }
    var exp= new JsonExport(speseTemp,piani);
    const json = JSON.stringify(exp, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'DatiExport.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Carica dati JSON
  document.getElementById('loadBtn').addEventListener('click', () => {
    document.getElementById('fileInput').click();
  });

document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    try {
      const dati = JSON.parse(event.target.result);

      if (!dati.spese || !Array.isArray(dati.spese)) throw new Error("Formato JSON non valido: manca 'spese'");
      if (!dati.piani || !Array.isArray(dati.piani)) throw new Error("Formato JSON non valido: manca 'piani'");
      spese = [];
      piani =[];
      spese = dati.spese.map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      piani = dati.piani.map(p => new PianoAccumulo(p.id));

      saveData();          
      savePiano();
      loadPiano();
      popolaSelectPiani();


      alert("Dati caricati correttamente!");
    } catch (error) {
      alert("Errore nel caricamento dati: " + error.message);
    }
    e.target.value = ""; // reset input file per poter caricare pi√π volte lo stesso file
  };
  reader.readAsText(file);
});

loadPiano();
popolaSelectPiani();

  document.getElementById('Cal-tab').addEventListener('click', () => {
    const budgets = document.querySelectorAll('.month-budget');
    budgets.forEach((budget, idx) => {
        var val=0;

        const sommaMese = spese.reduce((acc, spesa) => {
        const dateObj = new Date(spesa.data);
        if (dateObj.getMonth() === idx && spesa.tipologia==="Aggiunta Budget") {
            return acc + Number(spesa.importo);
        }
        return acc;
        }, 0);

      budget.textContent = "Budget: "+ sommaMese;
    });
  });
    document.getElementById('Cal-tab').addEventListener('click', () => {
    const budgets = document.querySelectorAll('.month-spese');
    budgets.forEach((budget, idx) => {
                var val=0;

        const sommaMese = spese.reduce((acc, spesa) => {
        const dateObj = new Date(spesa.data);
        if (dateObj.getMonth() === idx && spesa.tipologia!=="Aggiunta Budget") {
            return acc + Number(spesa.importo);
        }
        return acc;
        }, 0);
      budget.textContent = "Spese: "+ sommaMese;
    });
  });
</script>
</body>
</html>

