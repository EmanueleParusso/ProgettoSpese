<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<title>Gestione Spese</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<!-- Font system iOS-like -->
<style>
  @font-face {
    font-family: 'SF Pro Text';
    src: local('SF Pro Text'), local('San Francisco'), local('Helvetica Neue'), local('Helvetica'), local('Arial'), sans-serif;
  }

  body {
  max-width: 480px; /* larghezza tipica mobile */
  margin: 0 auto;
  border: 1px solid #ccc; /* opzionale, per vedere il confine */
  overflow-x: hidden;
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #f5f5f7;
    color: #1c1c1e;
    padding-top: 4.5rem;
}
input.form-control {
  height: 38px;       /* altezza standard Bootstrap 5 */
  padding: 0.375rem 0.75rem; /* padding standard */
  box-sizing: border-box;
}

input[type="date"].form-control {
  height: 38px;       /* forza altezza uguale */
  padding: 0.375rem 0.75rem;
}


  /* Navbar */
  nav.navbar {
    background: #fff;
    border-bottom: 1px solid #ddd;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.05);
  }
  nav.navbar .navbar-brand {
    font-weight: 600;
    font-size: 1.4rem;
    color: #007aff;
  }
  nav.navbar .nav-tabs {
    border-bottom: none;
  }
  nav.navbar .nav-link {
    color: #007aff;
    font-weight: 600;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 1rem;
    transition: background-color 0.3s;
  }
  nav.navbar .nav-link.active,
  nav.navbar .nav-link:hover {
    background: #007aff;
    color: white !important;
  }
  /* Container */
  .container {
    max-width: 480px;
  }
  /* Dashboard Cards */
  .dashboard {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .card-dashboard {
    background: white;
    border-radius: 1rem;
    box-shadow: 0 10px 15px rgb(0 122 255 / 0.15);
    padding: 1.5rem 1rem;
    text-align: center;
    color: #007aff;
    font-weight: 700;
    user-select: none;
  }
  .card-dashboard .icon {
    font-size: 2.5rem;
    margin-bottom: 0.3rem;
  }
  .card-dashboard .label {
    font-weight: 500;
    font-size: 0.9rem;
    color: #3a3a3c;
  }
  .card-dashboard .value {
    font-size: 1.7rem;
    margin-top: 0.2rem;
  }
  /* Buttons */
  button.btn {
    border-radius: 1.5rem;
    font-weight: 600;
    padding: 0.5rem 1.4rem;
    box-shadow: 0 4px 8px rgb(0 122 255 / 0.2);
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  button.btn-primary {
    background-color: #007aff;
    border: none;
  }
  button.btn-primary:hover {
    background-color: #005ecb;
    box-shadow: 0 6px 14px rgb(0 122 255 / 0.3);
  }
  button.btn-success {
    background-color: #34c759;
    border: none;
  }
  button.btn-success:hover {
    background-color: #28a745;
    box-shadow: 0 6px 14px rgb(52 199 89 / 0.3);
  }
  /* Form controls */
  input.form-control, select.form-select {
    border-radius: 1rem;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    padding: 0.5rem 1rem;
    font-weight: 600;
    font-size: 1rem;
  }
  input.form-control:focus, select.form-select:focus {
    border-color: #007aff;
    box-shadow: 0 0 8px rgb(0 122 255 / 0.5);
  }
  /* Lista Spese cards */
  .card-spesa {
    border-radius: 1rem;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.07);
    margin-bottom: 1rem;
    transition: box-shadow 0.3s;
  }
  .card-spesa:hover {
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.1);
  }
  .card-spesa .card-body {
    padding: 1rem 1.2rem;
  }
  .card-spesa .card-title {
    font-weight: 700;
    font-size: 1.1rem;
  }
  .card-spesa .card-text {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  .tipologia-Spesa\ effettiva {
    background-color: #007aff;
    color: white;
  }
  .tipologia-Spesa\ programmata {
    background-color: #ff9500;
    color: white;
  }
  .tipologia-Aggiunta\ Budget {
    background-color: #34c759;
    color: white;
  }
  .spesa-title {
  font-weight: 700;
  font-size: 1.2rem;
  color: #1c1c1e; /* testo scuro */
  margin-bottom: 0.3rem;
  display: flex;
  flex-direction: column;
  align-items: center; /* o flex-start se vuoi allinearlo a sinistra */
  gap: 4px;
}

.spesa-date {
  font-weight: 500;
  font-size: 0.85rem;
  color: #6e6e73; /* grigio chiaro */
  font-family: monospace; /* o un font normale, a tua scelta */
  display: flex;
  align-items: center;
  gap: 4px;
}

.spesa-date i {
  font-size: 1rem;
  color: #007aff; /* blu Apple */
}

  /* Select tipologia nella card */
  select.form-select-sm {
    border-radius: 1rem;
    width: auto;
    font-weight: 600;
    padding: 0.25rem 0.6rem;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
    cursor: pointer;
    transition: box-shadow 0.3s;
  }
  select.form-select-sm:focus {
    box-shadow: 0 0 6px rgb(0 122 255 / 0.5);
  }
  /* Delete button */
  button.btn-danger {
    border-radius: 1rem;
    font-weight: 600;
    padding: 0.3rem 0.8rem;
    font-size: 0.85rem;
    box-shadow: none;
    transition: background-color 0.3s;
  }
  button.btn-danger:hover {
    background-color: #cc0000;
    box-shadow: 0 0 8px rgb(204 0 0 / 0.5);
  }
  /* Pills for sub-tabs */
  #listSubTabs .nav-link {
    border-radius: 1.5rem;
    font-weight: 600;
    color: #007aff;
    padding: 0.4rem 1rem;
    margin-right: 0.4rem;
  }
  #listSubTabs .nav-link.active {
    background-color: #007aff;
    color: white !important;
    box-shadow: 0 4px 10px rgb(0 122 255 / 0.3);
  }
  /* Responsive */
  @media (max-width: 400px) {
    .dashboard {
      grid-template-columns: 1fr;
    }
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }

  /* Mesi */
  .month-card {
  background: white;
  border-radius: 1rem;
  box-shadow: 0 10px 15px rgb(0 122 255 / 0.15);
  color: #1c1c1e;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
    Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
}
.month-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 14px 22px rgb(0 122 255 / 0.25);
}
.month-header {
  font-weight: 600;
  font-size: 1.2rem;
  margin-bottom: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  color: #007aff;
}
.badge {
  background-color: #e1e1e6;
  color: #3a3a3c;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.9rem;
  padding: 6px 14px;
  margin: 6px 6px 0 6px;
  display: inline-block;
  min-width: 80px;
  text-align: center;
}
.month-budget {
  background-color: #d4f0d4; /* verde chiaro */
  color: #2d6a2d;
}
.month-spese {
  background-color: #f8d7da; /* rosa chiaro */
  color: #842029;
}

</style>
</head>
<body>

<nav class="navbar fixed-top">
  <div class="container d-flex flex-column align-items-start">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" style="display:none;">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab">üè† Home</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">‚ûï Aggiungi Movimento</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">üìã Lista Movimenti</button>
      </li>
       <li class="nav-item" role="presentation">
        <button class="nav-link" id="Cal-tab" data-bs-toggle="tab" data-bs-target="#month" type="button" role="tab">üìÖ Calendario</button>
      </li>
    </ul>
  </div>
</nav>

<div id="welcomeScreen" class="d-flex flex-column align-items-center" style="height:100vh;">
   <svg  width="150" height="150"  viewBox="0  0 120  120"  xmlns="http://www.w3.org/2000/svg">
      <rect  width="150" height="120"  rx="24"  fill="#F5F5F7"/>
      <path  d="M40 50h40a6  6  0 0  1  6 6v24a6  6  0 0  1-6  6H40a6 6  0  0 1-6-6V56a6  6  0 0  1  6-6z" fill="#007aff"/>
       <path d="M80  60h-12a6  6 0  0  0 0  12h12v-12z"  fill="#34C759"/>
      <circle  cx="74" cy="66"  r="2.5"  fill="#FFF"/>
   </svg>

  <form id="choosePlanForm" class="w-100 p-3" style="max-width: 400px;">
    <div class="mb-3">
      <label for="pianoSelect" class="form-label">Seleziona un piano</label>
      <select id="pianoSelect" class="form-select" required></select>
    </div>
    <button type="submit" class="btn btn-primary w-100">Apri Piano</button>
  </form>

  <hr class="my-4" style="width: 100px;"/>

  <form id="createPlanForm" class="w-100 p-3" style="max-width: 400px;">
    <div class="mb-3">
      <label for="titoloInputPiano" class="form-label">Oppure crea nuovo piano</label>
      <input type="text" class="form-control" id="titoloInputPiano" placeholder="Titolo del Piano" required />
    </div>
    <button type="submit" class="btn btn-success w-100">Crea Piano</button>
  </form>

  
      <div class="d-flex gap-2 mb-4">
        <button id="saveBtn" class="btn btn-primary flex-fill">üíæ Salva dati JSON</button>
        <button id="loadBtn" class="btn btn-success flex-fill">üìÇ Carica dati JSON</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none;">
      </div>
</div>


<div class="container">

  <div class="tab-content" id="mainTabsContent">

    <!-- HOME / DASHBOARD -->
    <div class="tab-pane fade" id="home" role="tabpanel" aria-labelledby="home-tab">
        <hr class="my-4" style="width: 100px;"/>
      <div class="dashboard">
        <div class="card-dashboard" id="cardSpeseEffettive">
          <div class="icon">üí∏</div>
          <div class="label">Spese Effettive</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
        <div class="card-dashboard" id="cardSpeseProgrammate">
          <div class="icon">üóìÔ∏è</div>
          <div class="label">Spese Programmate</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
        <div class="card-dashboard" id="cardBudget">
          <div class="icon">üí∞</div>
          <div class="label">Budget</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
        <div class="card-dashboard" id="cardRimanente">
          <div class="icon">üìä</div>
          <div class="label">Rimanente</div>
          <div class="value">0 ‚Ç¨</div>
        </div>
      </div>
    </div>

    <!-- AGGIUNGI SPESA -->
    <div class="tab-pane fade" id="add" role="tabpanel" aria-labelledby="add-tab">
         <hr class="my-4" style="width: 100px;"/>
      <form id="addSpesaForm" autocomplete="off">
        <div class="mb-3">
          <label for="titoloInput" class="form-label">Titolo movimento</label>
          <input type="text" class="form-control" id="titoloInput" placeholder="Descrizione del movimento" required />
        </div>
        <div class="mb-3 d-block gap-2"">
            <label for="dateInput" class="form-label">Data</label>
            <input type="date" class="form-control" id="dateInput"  name="dateInput" required />
        </div>
        <div class="mb-3 d-flex gap-2">
          <div class="flex-grow-1">
            <label for="importoInput" class="form-label">Importo</label>
            <input type="number" step="0.01" min="0" class="form-control" id="importoInput" placeholder="0.00" required />
          </div>
          <div style="width: 100px;">
            <label for="valutaInput" class="form-label">Valuta</label>
            <input type="text" class="form-control" id="valutaInput" placeholder="‚Ç¨" maxlength="3" />
          </div>
        </div>
        <div class="mb-4">
          <label for="tipologiaInput" class="form-label">Tipologia</label>
          <select id="tipologiaInput" class="form-select" required>
            <option value="Spesa effettiva">Spesa effettiva</option>
            <option value="Spesa programmata">Spesa programmata</option>
            <option value="Aggiunta Budget">Aggiunta Budget</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary w-100">Aggiungi Movimento</button>
      </form>
    </div>

    <!-- LISTA SPESE -->
    <div class="tab-pane fade" id="list" role="tabpanel" aria-labelledby="list-tab">
        <hr class="my-4" style="width: 100px;"/>

      <ul class="nav nav-pills mb-3" id="listSubTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="effettive-tab" data-bs-toggle="pill" data-bs-target="#effettive" type="button" role="tab">Spese Effettive</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="programmate-tab" data-bs-toggle="pill" data-bs-target="#programmate" type="button" role="tab">Spese Programmate</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="budget-tab" data-bs-toggle="pill" data-bs-target="#budget" type="button" role="tab">Aggiunte Budget</button>
        </li>
        <li class="nav-item" role="presentation">
          <a id="resetFilter" class="nav-link text-decoration-underline d-none"  style="color:#cc0000;">
            Reset Filter
          </a>
</li>
      </ul>

      <div class="tab-content" id="listSubTabsContent">
        <div class="tab-pane fade show active" id="effettive" role="tabpanel" aria-labelledby="effettive-tab">
          <div id="effettiveContainer"></div>
        </div>
        <div class="tab-pane fade" id="programmate" role="tabpanel" aria-labelledby="programmate-tab">
          <div id="programmateContainer"></div>
        </div>
        <div class="tab-pane fade" id="budget" role="tabpanel" aria-labelledby="budget-tab">
          <div id="budgetContainer"></div>
        </div>
      </div>
    </div>

<!-- MONTH -->
<div class="tab-pane fade" id="month" role="tabpanel" aria-labelledby="month-tab">
  <hr class="my-4" style="width: 100px;" />
<div class="alert alert-primary" role="alert"> <i class="bi bi-info-square"></i>
 HELP: Con un click sulla card di un mese puoi visualizzare tutti i dati per il mese selezionato</div>
  <div class="month-list">
    <!-- Gennaio -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.1s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Gennaio
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
<canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>
      </div>
    </div>

    <!-- Febbraio -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.2s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Febbraio
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Marzo -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.3s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Marzo
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Aprile -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.4s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Aprile
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Maggio -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.5s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Maggio
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Giugno -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.6s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Giugno
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Luglio -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.7s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Luglio
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Agosto -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.8s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Agosto
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Settembre -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 0.9s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Settembre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Ottobre -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 1s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Ottobre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Novembre -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 1.1s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Novembre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>

    <!-- Dicembre -->
    <div class="card month-card fade-in mb-3" style="animation-delay: 1.2s;">
      <div class="card-body text-center">
        <div class="month-header">
          <i class="bi bi-calendar3"></i> Dicembre
        </div>
        <span class="badge bg-light text-success month-budget mt-3 d-inline-block px-3 py-2"></span>
        <span class="badge bg-light text-danger month-spese mt-3 d-inline-block px-3 py-2"></span>
        <canvas class="month-chart d-block mx-auto mt-4" width="150" height="150"></canvas>

      </div>
    </div>
  </div>
</div>


</div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="filterModalLabel">Filtra Dati</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        Vuoi filtrare solo i dati di <span id="modalMonthName"></span>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-primary" id="confirmFilterBtn" >Conferma</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let spese = [];
  let piani =[];
  let currentPiano ="";
  const filterdiv = document.getElementById('resetFilter');

document.getElementById('createPlanForm').addEventListener('submit', (e) => {
  e.preventDefault(); // Blocca il comportamento predefinito del form

  const titolo = document.getElementById('titoloInputPiano').value.trim();
  piani.push(new PianoAccumulo(titolo));
  savePiano();
  currentPiano = titolo;
  const welcome = document.getElementById('welcomeScreen');
  welcome.classList.remove('d-flex');
  welcome.classList.add('d-none');

  loadData();
  updateRiepilogo();
  renderSpeseList();

  document.getElementById('mainTabs').style.display = 'flex';

  const homePane = document.getElementById('home');
  homePane.classList.add('show', 'active');
});
function popolaSelectPiani() {
  const select = document.getElementById('pianoSelect');
  select.innerHTML = "";

  if (piani.length === 0) {
    const option = document.createElement('option');
    option.textContent = "Nessun piano disponibile";
    option.disabled = true;
    option.selected = true;
    select.appendChild(option);
  } else {
    piani.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.id;
      select.appendChild(option);
    });
  }
}
document.getElementById('choosePlanForm').addEventListener('submit', e => {
  e.preventDefault();
  const selectedId = document.getElementById('pianoSelect').value;
  pianoCorrente = piani.find(p => p.id === selectedId);

  if (!pianoCorrente) return alert("Errore nel caricamento piano.");

    currentPiano = pianoCorrente.id;
  const welcome = document.getElementById('welcomeScreen');
  welcome.classList.remove('d-flex');
  welcome.classList.add('d-none');

  loadData();
  updateRiepilogo();
  renderSpeseList();

  document.getElementById('mainTabs').style.display = 'flex';

  const homePane = document.getElementById('home');
  homePane.classList.add('show', 'active');
});




  class Spesa {
    constructor(titolo, importo, valuta, tipologia,piano,data) {
      this.titolo = titolo;
      this.importo = importo;
      this.valuta = valuta;
      this.tipologia = tipologia;
      this.piano = piano;
      this.data=data;
    }
  }
  class PianoAccumulo {
    constructor(id) {
      this.id = id;
    }
  }
    class JsonExport {
    constructor(spese,piani) {
      this.spese = spese;
      this.piani = piani;
    }
  }



  const saveData = () => {
    const dati = localStorage.getItem('spese');
    var speseTemp = [];
    if (dati) {
      try {
        const arr = JSON.parse(dati);
         speseTemp = arr
        .filter(s => s.piano !== currentPiano)
        .map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
         speseTemp = [];
      }
    }
    const merged = speseTemp.concat(spese);
    localStorage.setItem('spese', JSON.stringify(merged));
  };
  const savePiano = () => {
    localStorage.setItem('piano', JSON.stringify(piani));
  };

  const loadData = () => {
    const dati = localStorage.getItem('spese');
    if (dati) {
      try {
        const arr = JSON.parse(dati);
        spese = arr
        .filter(s => s.piano === currentPiano)
        .map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
        spese = [];
      }
    }
  };

  const loadPiano = () => {
    const dati = localStorage.getItem('piano');
    if (dati) {
      try {
        const arr = JSON.parse(dati);
        piani = arr.map(s => new PianoAccumulo(s.id));
      } catch {
        piani = [];
      }
    }
  };

  // Elementi DOM containers
  const effettiveCont = document.getElementById('effettiveContainer');
  const programmateCont = document.getElementById('programmateContainer');
  const budgetCont = document.getElementById('budgetContainer');

  // Dashboard cards
  const cardSpeseEffettive = document.getElementById('cardSpeseEffettive').querySelector('.value');
  const cardSpeseProgrammate = document.getElementById('cardSpeseProgrammate').querySelector('.value');
  const cardBudget = document.getElementById('cardBudget').querySelector('.value');
  const cardRimanente = document.getElementById('cardRimanente').querySelector('.value');

  function formatCurrency(value, valuta = "‚Ç¨") {
    return value.toFixed(2) + " " + valuta;
  }

  function updateRiepilogo() {
    let totEffettive = 0;
    let totProgrammate = 0;
    let totBudget = 0;
    let valuta = "‚Ç¨";

    spese.forEach(s => {
      valuta = s.valuta || valuta;
      if (s.tipologia === "Spesa effettiva") totEffettive += s.importo;
      else if (s.tipologia === "Spesa programmata") totProgrammate += s.importo;
      else if (s.tipologia === "Aggiunta Budget") totBudget += s.importo;
    });

    cardSpeseEffettive.textContent = formatCurrency(totEffettive, valuta);
    cardSpeseProgrammate.textContent = formatCurrency(totProgrammate, valuta);
    cardBudget.textContent = formatCurrency(totBudget, valuta);
    const rimanente = totBudget - totEffettive - totProgrammate ;
    cardRimanente.textContent = formatCurrency(rimanente, valuta);
    cardRimanente.style.color = rimanente < 0 ? '#cc0000' : '#007aff';
  }

function renderSpeseList() {
  effettiveCont.innerHTML = "";
  programmateCont.innerHTML = "";
  budgetCont.innerHTML = "";

  spese.forEach((spesa, index) => {
    const card = document.createElement('div');
    card.className = 'card card-spesa mb-3';

    const cardBody = document.createElement('div');
    cardBody.className = 'card-body d-flex flex-column';

    // --- RIGA 1: Titolo a sx, data a dx ---
    const topRow = document.createElement('div');
    topRow.className = 'd-flex justify-content-between align-items-center';

    const titolo = document.createElement('h5');
    titolo.className = 'card-title mb-0';
    titolo.textContent = spesa.titolo;

    const dataSpan = document.createElement('small');
    dataSpan.className = 'text-muted';
    dataSpan.textContent = spesa.data;

    topRow.appendChild(titolo);
    topRow.appendChild(dataSpan);

    // --- RIGA 2: Importo centrato ---
    const importoWrapper = document.createElement('div');
    importoWrapper.className = 'd-flex justify-content-center my-2';

    const importoInput = document.createElement('input');
    importoInput.type = 'number';
    importoInput.className = 'form-control text-center fw-bold';
    importoInput.style.cssText = `
      max-width: 100px;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
      height: auto;
      border-radius: 0.6rem;
      box-shadow: none;
      border: 1px solid #ccc;
    `;
    importoInput.value = spesa.importo;
    importoInput.min = "0";
    importoInput.step = "0.01";
    importoInput.title = "Modifica importo";

    importoInput.addEventListener('change', () => {
      const nuovoImporto = parseFloat(importoInput.value);
      if (!isNaN(nuovoImporto) && nuovoImporto >= 0) {
        spesa.importo = nuovoImporto;
        saveData();
        updateRiepilogo();
        renderSpeseList(); // Rirenderizza la lista
      } else {
        alert("Importo non valido");
        importoInput.value = spesa.importo;
      }
    });

    const valutaSpan = document.createElement('span');
    valutaSpan.className = 'ms-2';
    valutaSpan.textContent = spesa.valuta || "‚Ç¨";

    const importoContainer = document.createElement('div');
    importoContainer.className = 'd-flex align-items-center';
    importoContainer.appendChild(importoInput);
    importoContainer.appendChild(valutaSpan);

    importoWrapper.appendChild(importoContainer);

    // --- RIGA 3: Pulsanti (tipologia + elimina) ---
    const bottomRow = document.createElement('div');
    bottomRow.className = 'd-flex justify-content-center gap-2 mt-3';

    const selectTipologia = document.createElement('select');
    selectTipologia.className = 'form-select form-select-sm';
    ["Spesa effettiva", "Spesa programmata", "Aggiunta Budget"].forEach(tipo => {
      const option = document.createElement('option');
      option.value = tipo;
      option.textContent = tipo;
      if (spesa.tipologia === tipo) option.selected = true;
      selectTipologia.appendChild(option);
    });
    selectTipologia.title = "Modifica tipologia spesa";

    selectTipologia.addEventListener('change', () => {
      spesa.tipologia = selectTipologia.value;
      saveData();
      updateRiepilogo();
      renderSpeseList();
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-danger btn-sm';
    deleteBtn.textContent = "Elimina";
    deleteBtn.title = "Elimina spesa";

    deleteBtn.addEventListener('click', () => {
      if (confirm(`Eliminare la spesa "${spesa.titolo}"?`)) {
        spese.splice(index, 1);
        saveData();
        updateRiepilogo();
        renderSpeseList();
      }
    });

    bottomRow.appendChild(selectTipologia);
    bottomRow.appendChild(deleteBtn);

    // Monta la card finale
    cardBody.appendChild(topRow);          // Riga 1: titolo + data
    cardBody.appendChild(importoWrapper);  // Riga 2: importo centrato
    cardBody.appendChild(bottomRow);       // Riga 3: pulsanti

    card.appendChild(cardBody);

    // Inserisci la card nel contenitore giusto
    if (spesa.tipologia === "Spesa effettiva") effettiveCont.appendChild(card);
    else if (spesa.tipologia === "Spesa programmata") programmateCont.appendChild(card);
    else if (spesa.tipologia === "Aggiunta Budget") budgetCont.appendChild(card);
  });
}

  // Gestione form aggiunta spesa
  document.getElementById('addSpesaForm').addEventListener('submit', e => {
    e.preventDefault();

    const titolo = document.getElementById('titoloInput').value.trim();
    const importo = parseFloat(document.getElementById('importoInput').value);
    const valutaInput = document.getElementById('valutaInput').value.trim();
    const valuta = valutaInput || "‚Ç¨";
    var data = document.getElementById('dateInput').value;
    const tipologia = document.getElementById('tipologiaInput').value;

    if (!titolo || isNaN(importo) || !tipologia) {
      alert("Compila tutti i campi correttamente!");
      return;
    }

    spese.push(new Spesa(titolo, importo, valuta, tipologia, currentPiano,data));
    console.log("Aggiunto spesa");
    saveData();
    updateRiepilogo();
    renderSpeseList();

    e.target.reset();

    // Torna alla lista spese dopo aggiunta
    const tabTrigger = bootstrap.Tab.getOrCreateInstance(document.querySelector('#list-tab'));
    tabTrigger.show();
  });

  // Salva dati in JSON
  document.getElementById('saveBtn').addEventListener('click', () => {
    const datiFULLspese = localStorage.getItem('spese');
    const datiFULLpiani = localStorage.getItem('piano');
     const dati = localStorage.getItem('spese');
    var speseTemp = [];
    if (datiFULLspese) {
      try {
        const arr = JSON.parse(datiFULLspese);
         speseTemp = arr.map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
         speseTemp = [];
      }
    }
    var exp= new JsonExport(speseTemp,piani);
    const json = JSON.stringify(exp, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'DatiExport.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Carica dati JSON
  document.getElementById('loadBtn').addEventListener('click', () => {
    document.getElementById('fileInput').click();
  });

    document.getElementById('resetFilter').addEventListener('click', () => {
      loadData();
      renderSpeseList();
      filterdiv.classList.toggle('d-none');
    });

document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    try {
      const dati = JSON.parse(event.target.result);

      if (!dati.spese || !Array.isArray(dati.spese)) throw new Error("Formato JSON non valido: manca 'spese'");
      if (!dati.piani || !Array.isArray(dati.piani)) throw new Error("Formato JSON non valido: manca 'piani'");
      spese = [];
      piani =[];
      spese = dati.spese.map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      piani = dati.piani.map(p => new PianoAccumulo(p.id));

      saveData();          
      savePiano();
      loadPiano();
      popolaSelectPiani();


      alert("Dati caricati correttamente!");
    } catch (error) {
      alert("Errore nel caricamento dati: " + error.message);
    }
    e.target.value = ""; // reset input file per poter caricare pi√π volte lo stesso file
  };
  reader.readAsText(file);
});

loadPiano();
popolaSelectPiani();

  document.getElementById('Cal-tab').addEventListener('click', () => {
    const budgets = document.querySelectorAll('.month-budget');
    budgets.forEach((budget, idx) => {
        var val=0;
        loadData();
        const sommaMese = spese.reduce((acc, spesa) => {
        const dateObj = new Date(spesa.data);
        if (dateObj.getMonth() === idx && spesa.tipologia==="Aggiunta Budget") {
            return acc + Number(spesa.importo);
        }
        return acc;
        }, 0);

      budget.textContent = "Budget: "+ sommaMese;
    });
  });
    document.getElementById('Cal-tab').addEventListener('click', () => {
    const budgets = document.querySelectorAll('.month-spese');
    budgets.forEach((budget, idx) => {
                var val=0;
        loadData();
        const sommaMese = spese.reduce((acc, spesa) => {
        const dateObj = new Date(spesa.data);
        if (dateObj.getMonth() === idx && spesa.tipologia!=="Aggiunta Budget") {
            return acc + Number(spesa.importo);
        }
        return acc;
        }, 0);
      budget.textContent = "Spese: "+ sommaMese;
    });
          GraficoMese();

  });

const monthCards = document.querySelectorAll('.month-card');
  const modal = new bootstrap.Modal(document.getElementById('filterModal'));
  const modalMonthName = document.getElementById('modalMonthName');
  const confirmBtn = document.getElementById('confirmFilterBtn');

  let selectedMonth = null;


  monthCards.forEach(card => {
    card.addEventListener('click', () => {
      selectedMonth = card.querySelector('.month-header').textContent.trim();
      modalMonthName.textContent = selectedMonth;
      modal.show();
    });
  });

  confirmBtn.addEventListener('click', () => {
     const dati = localStorage.getItem('spese');
     const idx = monthNameToIndex(selectedMonth);
    if (dati) {
      try {
        const arr = JSON.parse(dati);
        spese = arr
        .filter(s => s.piano === currentPiano &&(new Date(s.data)).getMonth() ===idx)
        .map(s => new Spesa(s.titolo, s.importo, s.valuta, s.tipologia, s.piano,s.data));
      } catch {
        spese = [];
      }
    }
    filterdiv.classList.toggle('d-none');
    renderSpeseList();
    const tabTrigger = bootstrap.Tab.getOrCreateInstance(document.querySelector('#list-tab'));
    tabTrigger.show();
    modal.hide();
  });

  function monthNameToIndex(monthName) {
    const mesi = [
      'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
    ];

    return mesi.findIndex(m => m.toLowerCase() === monthName.toLowerCase());
  }

  function GraficoMese() {
    const monthCards = document.querySelectorAll('.month-card');

    monthCards.forEach(card => {
      const budgetElem = card.querySelector('.month-budget');
      const speseElem = card.querySelector('.month-spese');
      const canvas = card.querySelector('.month-chart');

      const budget = parseFloat(budgetElem?.textContent.replace(/[^\d]/g, '')) || 0;
      const spese =  parseFloat(speseElem?.textContent.replace(/[^\d]/g, '')) || 0;
      let data = [spese, budget];
      const allZero = data.every(value => value === 0);
      if ((budget === 0 && spese === 0)) {
        data = [1];
      }
      if (canvas) {
        new Chart(canvas.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels:allZero ?['No Value']:['Spese', 'Budget'],
            datasets: [{
              data: data,
              backgroundColor:allZero
          ? ['#e0e0e0'] // grigio per 'nessun dato'
          : ['#dc3545', '#198754'], // rosso e verde
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: false,
            cutout: '70%',
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                 label: function(context) {
                  return allZero ? null : `${context.label}: ‚Ç¨${context.parsed}`;
                }
                }
              }
            }
          }
        });
      }
    });
  };


</script>

</body>
</html>
